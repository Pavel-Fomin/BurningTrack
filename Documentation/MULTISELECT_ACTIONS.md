Multi-Select Actions Specification (v1)

Назначение документа

Этот документ фиксирует контракт мультивыбора треков и набор действий, которые могут быть выполнены над выбранными треками.

Документ является архитектурной спецификацией, а не UI-описанием.
Любая реализация UI и бизнес-логики должна ей соответствовать.

⸻

Базовые инварианты
    1.    Мультиселект никогда не работает с Track / URL напрямую — только с TrackID.
    2.    Любое действие принимает массив trackIDs: [TrackID].
    3.    Порядок trackIDs сохраняется и имеет значение.
    4.    Любое действие возвращает BatchResult.
    5.    Частичный успех — допустимая и ожидаемая ситуация.
    6.    UI не содержит логики выполнения операций над файлами.

⸻

Общие типы

TrackID

Уникальный идентификатор трека в TrackRegistry.

⸻

BatchResult

Результат выполнения действия над несколькими треками.

Содержит:
    •    successIDs — успешно обработанные треки
    •    failed — треки с ошибкой выполнения
    •    skipped — треки, пропущенные по логическим причинам

Каждый failed / skipped содержит:
    •    trackID
    •    reason

⸻

FailureReason (общие причины)
    •    trackNotFound
    •    fileAccessDenied
    •    bookmarkInvalid
    •    operationNotSupported
    •    unknownError

⸻

SkipReason (логические причины)
    •    alreadyExists
    •    noRequiredTags
    •    nameConflict
    •    noChangesDetected

⸻

Набор действий мультиселекта

⸻

1. Отправить в плеер

Назначение

Добавить выбранные треки в плейлист плеера.

Входные параметры
    •    trackIDs: [TrackID]
    •    insertMode: append (v1 — только append)

Предусловия
    •    trackIDs не пустой
    •    треки существуют в TrackRegistry

Выполнение
    •    треки добавляются в конец плейлиста плеера
    •    политика дублей фиксируется заранее:
    •    либо дубли разрешены
    •    либо уже существующие треки пропускаются

Результат
    •    success: успешно добавленные
    •    failed: отсутствующие или недоступные треки

UI-поток
    •    кнопка “В плеер”
    •    выполнение без подтверждения
    •    краткий итог выполнения

⸻

2. Отправить в треклист

Назначение

Добавить выбранные треки в указанный треклист.

Входные параметры
    •    trackIDs: [TrackID]
    •    targetTrackListID

Предусловия
    •    trackIDs не пустой
    •    целевой треклист существует

Выполнение
    •    открывается выбор треклиста (sheet)
    •    треки добавляются в конец списка
    •    политика дублей фиксируется заранее

Результат
    •    success: добавленные треки
    •    failed: ошибки добавления или сохранения

⸻

3. Массовое редактирование тегов

Назначение

Изменить одинаковые поля тегов для нескольких треков.

Поддерживаемые поля (v1)
    •    year
    •    genre
    •    album
    •    comment

Входные параметры
    •    trackIDs: [TrackID]
    •    TagPatch — модель изменяемых полей

Выполнение

Для каждого трека:
    1.    Получить URL через bookmark resolver
    2.    Открыть файл через TagLib
    3.    Применить patch
    4.    Сохранить файл
    5.    Обновить runtime-метаданные

Возможные ошибки
    •    нет доступа к файлу
    •    формат не поддерживает запись тега
    •    ошибка сохранения

Результат
    •    success
    •    failed (с указанием причины)
    •    skipped (если значение уже совпадает)

UI-поток
    •    кнопка “Теги”
    •    batch-редактор
    •    кнопка Apply → выполнение → итог

⸻

4. Массовое переименование файлов из тегов

Назначение

Переименовать каждый файл индивидуально на основе его тегов.

Поддерживаемые стратегии (v1)
    •    artist + title
    •    title + artist

Входные параметры
    •    trackIDs: [TrackID]
    •    RenameStrategy

⸻

Этап 1: Построение плана переименования

Для каждого трека:
    •    прочитать нужные теги
    •    построить целевое имя файла
    •    если теги отсутствуют → skipped

Проверки:
    •    коллизии внутри выбранного набора
    •    существование файла с таким именем в папке

Результат этапа — RenamePlan.

⸻

Этап 2: Применение

Для каждого элемента плана:
    •    выполнить rename файла
    •    обновить TrackRegistry
    •    обновить bookmark
    •    обновить runtime-состояние

⸻

Возможные ошибки
    •    конфликт имён
    •    файл недоступен
    •    rename запрещён
    •    ошибка обновления registry / bookmark

Результат
    •    success
    •    failed
    •    skipped

⸻

UI-поток
    •    кнопка “Переименовать”
    •    выбор стратегии
    •    preview старое → новое
    •    подтверждение → выполнение → итог

⸻

Заключение

Данный документ является единственным источником истины для мультиселекта.

Добавление новых действий или расширение существующих не должно нарушать описанные инварианты.
