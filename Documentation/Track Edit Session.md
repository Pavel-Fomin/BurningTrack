# Track Edit Session — архитектурный контракт

## Назначение

Edit Session — это изолированная сессия редактирования одного трека,
которая аккумулирует изменения из разных UI-секций и применяет их
одним подтверждением.

Сессия:
- не изменяет данные трека напрямую
- существует только в режиме редактирования
- либо коммитится целиком (✓), либо отбрасывается (×)

---

## Область ответственности

Edit Session отвечает за:
- хранение черновых (draft) значений
- сравнение черновиков с исходным состоянием
- определение набора операций, которые нужно выполнить
- порядок применения операций
- безопасный выход без побочных эффектов

Edit Session **не отвечает** за:
- UI
- навигацию
- показ ошибок
- физические операции с файлами
- прямую запись тегов

---

## Жизненный цикл

### 1. Создание
Edit Session создаётся при входе в режим редактирования.

На этом этапе:
- фиксируется исходное состояние трека
- инициализируются draft-значения

Исходное состояние считается read-only.

---

### 2. Активное редактирование
Пока сессия активна:
- пользователь может редактировать любые поля
- изменения пишутся только в draft
- секции редактирования независимы друг от друга

Редактирование может быть:
- частичным
- в любом порядке
- с возвратами и повторными правками

---

### 3. Подтверждение (✓)
При подтверждении:
1. вычисляется diff между исходным состоянием и draft-значениями
2. формируется список операций
3. выполняются только необходимые операции
4. сессия завершается

---

### 4. Отмена (×)
При отмене:
- все draft-значения отбрасываются
- исходное состояние остаётся нетронутым
- никакие операции не выполняются

---

## Структура Edit Session (логическая)

### Исходное состояние
- имя файла
- теги
- обложка
- идентификаторы трека

Исходное состояние никогда не мутируется.

---

### Draft-состояние
Edit Session содержит независимые черновики:
- Draft Filename
- Draft Tags
- Draft Artwork

Каждый draft:
- изменяется независимо
- может совпадать с исходным значением
- не знает о других draft-ах

---

## Поддерживаемые типы изменений

### 1. Имя файла
- сравнивается с исходным именем
- пустое значение недопустимо
- расширение файла всегда сохраняется
- операция считается потенциально опасной

---

### 2. Теги
- сравнение выполняется по каждому полю
- пустое значение означает удаление тега
- при отсутствии изменений операция не выполняется

---

### 3. Обложка
- добавление
- замена
- удаление
- отсутствие изменений → операция не выполняется

---

## Формирование операций

При подтверждении Edit Session формирует набор операций, например:
- RenameFile
- UpdateTags
- UpdateArtwork

Операции:
- логически независимы
- выполняются последовательно
- могут отсутствовать полностью (no-op)

---

## Порядок выполнения операций

Рекомендуемый порядок:
1. Переименование файла
2. Обновление тегов
3. Обновление обложки

Причина:
- операции с файлом могут изменить URL
- последующие операции должны работать с актуальным путём

---

## Интеграция с архитектурой

- Edit Session живёт в контейнере
- UI (sheet) работает только с draft-значениями
- команды выполняются через AppCommandExecutor
- прямых IO-вызовов внутри Edit Session нет

---

## Поведение кнопки ✓

Кнопка ✓:
- активна только если есть хотя бы одно изменение
- коммитит всю Edit Session целиком
- не зависит от того, в какой секции были изменения

---

## Гарантии контракта

Edit Session гарантирует:
- отсутствие частичных сохранений
- отсутствие побочных эффектов при отмене
- единый источник истины для diff-логики
- возможность масштабирования (новые типы изменений)

---

## Нецели

Edit Session сознательно не решает:
- стратегии автопереименования
- массовое редактирование
- разрешение конфликтов файлов
- UI-валидацию ввода

---

## Кратко

Edit Session — это логический контракт между:
inline-редактированием → diff → командами → сохранением.
